---
title: "Diel pre-examinations"
output: 
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r startup, results='hide', include=FALSE}
## source necessary packages
library("mgcv")
library("ggplot2")
library("viridis")
library("extrafont")
library("grid")
library("reshape2")
library("gridExtra")

## create a theme to save linespace in plots
papertheme <- theme_bw(base_size=14, base_family = 'Arial') +
  theme(legend.position='top')

## load necessary data and make transformations
if (!file.exists('../data/private/bpbuoy2014-mod.rds')) {
  source("diel-buffalo.R")}
bdat <- readRDS('../data/private/bpbuoy2014-mod.rds')
bdat <- bdat[order(bdat$datetime),]


bdat$cdom[bdat$cdom < 0]  <- NA
bdat$turb[log10(bdat$turb) > 2.9] <- NA

## melt for atmospheric parameters
bair <- melt(bdat, id.vars = "datetime", measure.vars = c("windsp", "winddir", "airtemp", "pressure", "dailyrain", "par1"))
bair$depth <- rep(0)
bair$variable <- as.character(bair$variable)
bair$variable[grep("dsp", bair$variable)] <- "a.Wind (m/s)"
bair$variable[grep("ddir", bair$variable)] <- "b.Wind (deg.)"
bair$variable[grep("air", bair$variable)] <- "c.Air T."
bair$variable[grep("pres", bair$variable)] <- "d.Air P.(hPa)"
bair$variable[grep("daily", bair$variable)] <- "e.Rain (mm)"
bair$variable[grep("par", bair$variable)] <- "f.PAR (air)."

## melt for temperature and clean temp data (temp3 rotten throughout)
btemp <- melt(bdat, id.vars = "datetime", measure.vars = c("temp1", "temp2", "temp4",
                                                           "temp5", "temp6"))
btemp$depth <- rep(0)
btemp$depth[grep("1", btemp$variable)] <- 106
btemp$depth[grep("2", btemp$variable)] <- 294
btemp$depth[grep("4", btemp$variable)] <- 54
btemp$depth[grep("5", btemp$variable)] <- 123
btemp$depth[grep("6", btemp$variable)] <- 218

btemp$value[which(btemp$value < 0)] <- NA
btemp$value[which(btemp$value > 23 & btemp$variable == "temp6")] <- NA # no idea why this is happening in temp6!

btemp$variable <- rep("i. Water T.")

## melt for two-depth limno parameters
blimno <- melt(bdat, id.vars = "datetime", measure.vars = c("ph1", "ph2", "ODOrel1","ODOrel2",
                                                          "bga2cell", "bga1cell"))
blimno$variable <- as.character(blimno$variable)
blimno$depth <- rep(106)
blimno$depth[grep("2", blimno$variable)] <- 294

blimno$variable[grep("ph", blimno$variable)] <- "j. pH"
blimno$variable[grep("ODO", blimno$variable)] <- "k. O2 (%)"
blimno$variable[grep("bga", blimno$variable)] <- "l.Phyco (cell/ml)"

## one-depth limno parameters
bones <- melt(bdat, id.vars = "datetime", measure.vars = c("chl", "co2corr"))
bones$depth <- rep(106)
bones$variable <- as.character(bones$variable)
bones$variable[grep("corr", bones$variable)] <- "g. CO2 (ppm)"
bones$variable[grep("chl", bones$variable)] <- "h. Chl (ug/L)"

## combine for megamelt and reorder if needed
megamelt <- rbind(bair, bones, btemp, blimno)
#megamelt <- within(megamelt, variable <- factor(variable, levels = sample(levels(Group))))


## melt for PAR plot
bdat$par2[bdat$par2 < 0] <- NA # deal with -100 000 values
bdat$par3[bdat$par3 < 0] <- NA
bdat$par2frac <- bdat$par2/bdat$par1 * 100
bdat$par3frac <- bdat$par3/bdat$par1 * 100
bdat$par2frac[is.infinite(bdat$par2frac)] <- NA
bdat$par3frac[is.infinite(bdat$par3frac)] <- NA
bpar <- melt(bdat, id.vars = c("datetime", "isDay", "Hour"), measure.vars = c("par1", "par2", "par3",
                                                                              "par2frac", "par3frac"))
bpar$depth <- rep(0)
bpar$depth[grep("1", bpar$variable)] <- "Air"
bpar$depth[grep("2", bpar$variable)] <- '74'
bpar$depth[grep("3", bpar$variable)] <- '106'

bpar$isFrac <- rep(FALSE)
bpar$isFrac[grep("frac", bpar$variable)] <- TRUE

## melt for turbplot
bturb <- melt(bdat, id.vars = "datetime", measure.vars = c("co2corr", "cdom", "turb"))
bturb$variable <- as.character(bturb$variable)
bturb$value[bturb$variable == "turb"] <- log10(bturb$value[bturb$variable == "turb"])
bturb$variable[grep("co2", bturb$variable)] <- "a. CO2 (ppm)"
bturb$variable[grep("turb", bturb$variable)] <- "b. Turb (log10 NTU)"
bturb$variable[grep("dom", bturb$variable)] <- "c. CDOM (ug/L)"


```

```{r models, results='hide', include=FALSE}
## a lot of this code from diel-buffalo-models.R
lmnight <- with(bdat[bdat$isDay == FALSE,], lm(co2corr~pco2))
lmday <- with(bdat[bdat$isDay == TRUE,], lm(co2corr~pco2))
lmint <- with(bdat, lm(co2corr~pco2))

phmod <- gam(ph1 ~ ti(Time, bs = "cc") + ti(DOY) + ti(Time, DOY, bs = c("cc","tp")), 
          data = bdat)
co2mod <- gam(co2corr ~ ti(Time, bs = "cc") + ti(DOY) + ti(Time, DOY, bs = c("cc","tp")), 
            data = bdat)

```
## Buffalo Pound data: 2014, ca 90 days

Buffalo Pound data exist from 2014 and we are waiting for any available 2016 data. We have enough supporting data to calculate pCO2 which needs doing for the diel paper in order to include Wascana as well (it's also interesting in its own right).

We have the following information for every 15mins (some data more patchy than others):

*   Meterorological: Wind speed & direction, air temperature, relative humidity, pressure, daily rain, PAR
* Shallow (106cm): PAR, temperature, oxygen (% and abs), chl (rfu), phycocyanin (rfu), conductivity (uS/cm), pH; assuming that turbidity (NTU+), CDOM (ug/L) also from this depth
* Deep (294cm): Temperature, oxygen (% and abs), chl (rfu), phycocyanin (rfu), conductivity (uS/cm), pH
* 74cm: PAR
* ++ Thermistor chain for temperature but need to check which exact depths with Helen

### Time series of all variables

Wind speed and direction are variable at fairly high resolution and do not show strong seasonality. Air temperature predictably increases through June. Air pressure dips through the season and is at times, but not consistently, associated with rain events. Highest PAR occurs in June, however cloudy days with lower PAR occur throughout. Above-atmospheric levels of CO~2~ occur in June, and the lowest values occur in July. Variability increases in August when the highest values occur. The variability does not seem related to variation in chl, however the chl values should still be verified against routines sampling data from that summer. pH and oxygen are both slighly lower in August, which could explain the variation... But why are these lower then? Water temperature is at its highest in August as well, and my guess would be that respiration is starting to kick in....? 

Stratification does occur at Buffalo Pound throughout the season, most notably over three events in July. It could be that the stability of the water column promotes high pH at the surface, and increased mixing in August brings in the "respiration signal".

Questions to think about - how much should I pursue physical controls? e.g. should I develop a model to explain stratification events using wind speed, -direction and temperature or should I just focus on using stratification to explain pH/CO~2~? 


<!--```{r tempplots, fig.cap="Water temperature at different depths over the study period"}
ggplot(data = btemp, aes(y=value, x=datetime, group=factor(depth), col=factor(depth))) +
  papertheme +
  geom_line() +
  scale_color_viridis(discrete = TRUE, begin= 0.1, end=0.8, 
                      option = 'viridis', direction = -1, name="Depth (cm)") +
  ylab("Temperature") + xlab("Date")

``` -->


```{r meltplot, fig.height=14, fig.width=9, fig.cap="Most measured variables over time, showing intermittent stratification"}

ggplot(data = megamelt, aes(y=value, x=datetime, group=variable, col=factor(depth))) +
  papertheme +
  geom_line() +
  facet_wrap('variable', scales='free_y', ncol=1, switch="y") +
  scale_color_viridis(discrete = TRUE, begin= 0.1, end=0.9, 
                      option = 'viridis', direction = -1, name="Depth (cm)") +
  theme(axis.title=element_blank())
```

We seem to have some interesting issues with PAR since a plot by hour seems to indicate that later in the day, the deeper sonde is registering more incident light than the shallower sonde. Note that some values had to be removed as outliers as well.... Will need to think about how and if to include it in the models. The same thing applies for CDOM and turbidity (Fig. xx) -- they seem to trip out fairly often so need to check everything is legit. Also -- what on earth is happening in August? If all there is true, there might be reason to believe that the CDOM is autochthonously produced given the increase over the season? (I would doubt that overland flow would be the source given the dearth of heavy rain events in 2014, and them being in July???)

```{r parplots, fig.height = 13, fig.width=9, fig.cap="% of air PAR intercepted at different depths over the study period, by hour. Later in the day it seems the deeper sensor is registering higher PAR which needs some investigation"}
ggplot(data = bpar[bpar$isDay==TRUE & bpar$isFrac == TRUE,], aes(y=value, x=datetime, group=factor(depth), col=factor(depth))) +
  papertheme +
  facet_grid(Hour ~ .) +
  geom_line() +
  scale_color_viridis(discrete = TRUE, begin= 0.1, end=0.8, 
                      option = 'viridis', direction = -1, name="Depth (cm)") +
  ylab("% PAR of air intercepted") + xlab("Date") + scale_y_continuous(limits = c(0, 100))

```

```{r turbplots, fig.cap="bluh", fig.width=6, fig.height=3}
ggplot(data=bturb, aes(y=value, x=datetime)) +
  papertheme +
  geom_point(size=0.3) +
  facet_grid(variable ~ ., scales = "free_y") +
  theme(axis.title = element_blank(), strip.text.y = element_text(size = 6))
```

\newpage 

### Relationship between key variables identified in routines analysis
The relationship between shallow pH and CO~2~ is strong especially during night. There is much more scatter during the day. The relationship between deep pH and CO~2~ is poor (not shown) suggesting that there is reasonable vertical separation in the water column over the season. Is it possible that the small difference in depth between the pH (106 cm) and CO~2~ (89 cm) could explain the difference during the day, if productivity is particularly high at the surface (therefore CO~2~ lower than expected based on pH which seems to occur frequently).

```{r relationplots, fig.width=5, fig.height= 4, fig.cap="The relationship between CO2 and pH is strong, but tighter at night than during the day."}
ggplot(data = bdat, aes(y=co2corr, x=ph1, col=isDay)) +
  papertheme +
  geom_point(size=0.8) +
  scale_color_viridis(discrete = TRUE, alpha = 0.4,  begin= 0.3, end=0.8, 
                      option = 'viridis', direction = 1, name="", breaks = c(TRUE, FALSE), labels = c("Day", "Night")) +
 ylab(expression(paste(italic(p)*"CO"[2]~"(ppm)"))) +
  geom_abline(slope=0, intercept=400, lty=2, col="grey50") +
  xlab("pH") 

```

pCO~2~ had a stronger relationship with oxygen here than in the routines sampling (Fig. xxx), witih simultaneous supersaturation being rare. This is where we could try applying the Stets stuff if we wanted - pretty cool that both are simultaneously undersaturated at times!? 


```{r dielplots, plot-ref, fig.cap="Supesaturation of both oxygen and carbon dioxide occurs at day and night, and the differences aren't huge \\label{fig:plot}"}
lmplot <- ggplot(data=bdat, aes(y = co2corr, x = ODOrel1, col=TimeofDay)) +
  geom_point() +
  scale_color_viridis(discrete=TRUE, alpha = 0.4, option='viridis', begin= 0.3, end=0.8, direction = -1) +
  ylab(expression(paste(italic(p)*"CO"[2]~"(ppm)"))) +
  xlab(expression(paste("O"[2]~"(%)"))) +
  geom_abline(slope=0,intercept = 400, linetype='dotted') +
  geom_vline(xintercept = 100, linetype='dotted') +
  papertheme +
  theme(legend.title=element_blank(), legend.position='top')

labeldf <- data.frame(x=1.65, y=450, label="~atmospheric pCO2")

boxplot <- ggplot(bdat, aes(isDay, co2corr)) +
  theme_bw(base_size=11, base_family = 'Arial') +
  theme(legend.position='top') +
  geom_boxplot() +
  geom_hline(yintercept = 400, lty=2) +
  #geom_text(data = labeldf, aes(x=x, y=y, label=label), inherit.aes = FALSE) +
  ylab(expression(paste(italic('p')*'CO'[2]~'(ppm)'))) +
  scale_x_discrete(labels=c("Night", "Day")) +
  xlab("p < 0.001")

vp <- viewport(width = 0.33, height = 0.44, x=0.75, y=0.6)
print(lmplot)
print(boxplot, vp=vp)
```
### Diel amplitudes

Overall, night-time CO~2~ was not massively (but indeed significantly) higher than during the day, when pooled over the whole season. Diel fluctuations in CO~2~ did, however, occur, shown here by modeling CO~2~ based on day of year, and time of day. The pattern shows that the large amplitude in CO~2~ during August is due to day-night differences, supporting a respiration-driven pathway. I haven't plotted it but oxygen is pretty much the same pooled over the season - night a bit lower but really not much and I doubt it would be significant. This raises one important question -- could our close-to atmospheric pCO~2~ NOT reflect the lakes per se (in that they are, say, below or close to below atmospheric) but just wind mixing being sufficient to mostly efficiently effluxing CO~2~ -- and therefore we never witness strong oversaturation. i.e. our lakes might have exactly the same reservoir of CO~2~ as boreal lakes, it's just that the wind keeps strong gradients from developing most of the time? Something to think about....Still doesn't take away from the brill fact that July is completely under equilibrium, if we decide to think of that as a brill thing in terms of marketing prairie lakes for carbon sequestration. Like, maybe the amplitudes are low due to WIND and not hardwater effect. Perhaps we could test wind here  (say, mean night CO~2~ - mean day CO~2~ modeled against mean 24h, or day \& night wind?) and if it doesn't affect amplitude we could safely say that hardwaters are generally less amplitude-y than softwaters...

```{r dielgams, plot-ref, fig.cap="blah \\label{gams}"}
## for co2
N <- 200
simDOY <- c(168:170, 190:192, 228:230)
DOYgroup <- factor(rep(1:3, times=c(3,3,3)))
DOYgroup <- factor(rep(c('Jun 17-19', 'Jul 9-11', 'Aug 16-18'), times=c(3,3,3)))  
reptimes <- length(simDOY)
preddf <- data.frame(`Time` = rep(seq(min(bdat$Time, na.rm=TRUE),
                                      max(bdat$Time, na.rm=TRUE),
                                      length = N), times=reptimes),
                     `DOY` = rep(simDOY, each = N))
co2modpred <- predict(co2mod, newdata = preddf, type = "link")

DOYgroups <- rep(DOYgroup, each = N)

predicted <- cbind(preddf, co2modpred, DOYgroups)
names(predicted)[which(names(predicted)=='co2modpred')] <- 'pCO2'

labdatco2 <- data.frame(x = 3, y = 380, label = "Mean (atm)")

ggplot(predicted, aes(x = Time, y = pCO2, group= DOY, col=DOYgroups)) +
  theme_bw(base_size = 10) +
  scale_colour_brewer(name = "Date", type = 'qual', palette = 'Dark2', direction=1) +
  geom_line() +
  theme(legend.position="top") +
  xlab('Time of Day') + ylab(expression(paste(italic(p)*"CO"[2]~"(ppm)"))) +
  geom_abline(intercept = 398, slope = 0, linetype='dotted') +
  geom_text(data = labdatco2, aes(label = label, x = x, y = y), 
            show.legend = FALSE, inherit.aes = FALSE,  size = 3)

```

## My hypotheses and paper focus

Basically, I'd like to look at which controls operate on CO~2~ at diel scales in these lakes. Specifically, I'd again like to partition physical factors from metabolic factors where available (given complications where they interact, like low wind speeds promoting thermal stabolity and cyano blooms). Therefore I'd need chl and phycocyanin to be reliable because they are the only unequivocally metabolic variables I have at this resolution. Oxygen may be wind-equilibrated and not necessarily reflect algal abundance/respiration balances. Something to think about. 
Physical factors -- wind mixing, thermal stability, stratification.... basically could be encapsulated in one index as Gavin suggested. That would be tidy. Could include rain events but not sure since only a very few in the time series anyway?
Amplitudes - I hypothesised that diel amplitudes would be less in hardwater lakes than softwater lakes for a given level of production due to the pH being buffered. Like I alluded to before, this may only be testable if I can control for the evening-out effects of constant wind on concentrations (extremes may never be expected if the water is constantly turbulent).
Finally for our own purposes but also general guidance, it would be good to note how important night time is for understanding seasonal flux balance. And the comparison between measured and calculated as well, to strengthen the validity of our long term sampling results.

## Correspondence between measured and calculated CO~2~

Somewhat helpfully to our cause, calculated pCO~2~ has often been shown higher than actual pCO~2~ as seems to be the case for our Qu'Appelle data during the day (yes the slope is \> 1 but most scatter is below the line). Therefore it is likely that we are underestimating their sequestration capacity based on our routines sampling. This is also consistent with the scatter in the pCO~2~-pH relationship (Fig. xxx) where daytime things are a bit unpredictable and generally lower-than-expected pCO~2~ occurs at relatively low pH values.

However, the night-time measurements are higher than calculations, suggesting that some process is changing the relationship between pH and pCO~2~ so that other things become more important... We are obviously using the conductivity-alkalinity relationship here to calculate pCO~2~ so it may simply be a matter of the DIC-conductivity relationship breaking down at night when more DIC (i.e. CO~2~) is released. Would this be plausible?

Based on the literature I've read so far (which supports my hypothesis!!!), the amplitudes between day and night here are smaller than in most other eutrophic water bodies. In many such, night shifts the balance from net autotrophic to net heterotrophic and is crucial in estimating a correct seasonal balance. Here, it seems less important. For example through July, pCO~2~ is below atmospheric equilibrium both day and night. August may hint towards more heterotrophic autumns once respiration occurs so it would be really interesting to get pH our from Wascana sonde through September!!! Fingers crossed.

as shown in \ref{fig:plot}
```{r calcmeasured, fig.cap="The relationship between measured and calculated CO2 has a lot of scatter but generally follows a 1:1 line during the day. At night, the slope is different. Why?"}
abdf <- data.frame(isDay = c(TRUE, FALSE), intercept=c(lmday$coefficients[1],lmnight$coefficients[1]), slope=c(lmday$coefficients[2], lmnight$coefficients[2]))

labeldf <- data.frame(x=c(250,250), y=c(1700,1600), label=c("Night Rsq = 0.92, slope = 1.28", "Day Rsq = 0.72, slope = 1.04"))

ggplot(data=bdat, aes(y = co2corr, x = pco2, col=isDay)) + 
  papertheme +
  geom_point() +
  geom_abline(slope=1, intercept=0, color='black', lty=2) +
  geom_abline(data=abdf, aes(slope=slope, intercept=intercept, col=isDay), alpha=1, show.legend = TRUE) +
  scale_color_viridis(discrete = TRUE, alpha = 0.4,  begin= 0.3, end=0.8, 
                      option = 'viridis', direction = 1, name="", breaks = c(TRUE, FALSE), labels = c("Day", "Night")) +
  ylab(expression(paste('Measured'~italic('p')*'CO'[2]~'('*mu*'atm)'))) +
  xlab(expression(paste('Calculated'~italic('p')*'CO'[2]~'('*mu*'atm)'))) +
  geom_text(data=labeldf, aes(x=x, y=y , label=label), inherit.aes = FALSE)
